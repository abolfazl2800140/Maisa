# راهنمای آپلود تصاویر محصولات

## مشکل قبلی
قبلاً تصاویر به صورت **base64** در بادی ریکوئست ارسال می‌شدند که باعث می‌شد:
- سایز ریکوئست خیلی بزرگ بشه (چند مگابایت)
- خطای `request entity too large` رخ بده
- سرعت آپلود خیلی کند بشه

## راهکار جدید (استاندارد حرفه‌ای)

### 1. آپلود مستقیم فایل با Multipart/Form-Data
تصاویر حالا به صورت **فایل مستقیم** (نه base64) به بک‌اند ارسال می‌شن و بک‌اند:
- فایل رو دریافت می‌کنه
- در پوشه `public/uploads` ذخیره می‌کنه
- فقط URL فایل رو برمی‌گردونه

### 2. مزایای این روش
✅ سایز ریکوئست خیلی کمتر (فقط فایل خام)
✅ سرعت آپلود بالاتر
✅ مدیریت بهتر فایل‌ها
✅ امکان بهینه‌سازی تصاویر در سمت سرور
✅ استاندارد صنعتی

## تغییرات انجام شده

### بک‌اند (NestJS)

#### 1. ماژول آپلود
```
src/upload/
├── upload.module.ts
├── upload.controller.ts
└── upload.service.ts
```

#### 2. API Endpoints جدید
- `POST /upload/image` - آپلود یک تصویر
- `POST /upload/images` - آپلود چند تصویر (حداکثر 10)

#### 3. محدودیت‌ها
- فرمت‌های مجاز: JPG, PNG, WebP
- حداکثر حجم هر فایل: 5 مگابایت
- حداکثر تعداد فایل در هر ریکوئست: 10

#### 4. افزایش Body Size Limit
در `src/main.ts` حد مجاز body size به 50MB افزایش یافت (برای موارد خاص).

### فرانت‌اند (Next.js)

#### 1. تابع آپلود در `lib/api/admin.ts`
```typescript
async uploadImage(file: File): Promise<{ url: string }>
async uploadImages(files: File[]): Promise<{ urls: string[] }>
```

#### 2. تغییر در `app/admin/products/new/page.tsx`
تابع `handleFileUpload` حالا:
1. فایل‌ها رو بررسی می‌کنه
2. به سرور ارسال می‌کنه
3. URL های دریافتی رو به لیست تصاویر اضافه می‌کنه

## نحوه استفاده

### 1. آپلود تصویر در فرم محصول
```typescript
const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
  const files = e.target.files;
  if (!files) return;

  const validFiles = Array.from(files).filter(file => {
    return file.type.startsWith('image/') && file.size <= 5 * 1024 * 1024;
  });

  const result = await adminApi.uploadImages(validFiles);
  // result.urls شامل آدرس تصاویر آپلود شده
};
```

### 2. استفاده از URL در محصول
URL های دریافتی به صورت زیر هستند:
```
http://localhost:4000/uploads/1732512345-abc123.jpg
```

این URL ها در دیتابیس ذخیره می‌شن و برای نمایش تصاویر استفاده می‌شن.

## تنظیمات مورد نیاز

### 1. متغیرهای محیطی (.env)
```env
NEXT_PUBLIC_API_URL="http://localhost:4000"
```

### 2. پوشه آپلود
پوشه `public/uploads` باید وجود داشته باشه (خودکار ساخته می‌شه).

### 3. .gitignore
فایل‌های آپلود شده در git نادیده گرفته می‌شن:
```
/public/uploads/*
!/public/uploads/.gitkeep
```

## بهینه‌سازی‌های آینده (اختیاری)

### 1. فشرده‌سازی تصاویر
می‌تونید در `upload.service.ts` از کتابخانه‌هایی مثل `sharp` استفاده کنید:
```bash
npm install sharp
```

### 2. آپلود به Cloud Storage
برای پروداکشن بهتره از سرویس‌هایی مثل:
- AWS S3
- Cloudinary
- Google Cloud Storage
- Azure Blob Storage

استفاده کنید.

### 3. تولید Thumbnail
برای بهبود سرعت، می‌تونید نسخه‌های کوچک‌تر تصاویر رو تولید کنید.

## تست کردن

### 1. راه‌اندازی بک‌اند
```bash
npm run nest:dev
```

### 2. راه‌اندازی فرانت‌اند
```bash
npm run dev
```

### 3. تست آپلود
1. به پنل ادمین برید: `http://localhost:3000/admin/products/new`
2. یک یا چند تصویر انتخاب کنید
3. تصاویر باید با موفقیت آپلود بشن
4. محصول رو ذخیره کنید

## عیب‌یابی

### خطا: "request entity too large"
- اطمینان حاصل کنید که `body size limit` در `main.ts` افزایش یافته
- بررسی کنید که از آپلود مستقیم فایل استفاده می‌کنید (نه base64)

### خطا: "فایل آپلود نشد"
- بررسی کنید که پوشه `public/uploads` وجود داره
- مجوزهای نوشتن روی پوشه رو چک کنید

### تصاویر نمایش داده نمی‌شن
- URL تصاویر رو در دیتابیس چک کنید
- اطمینان حاصل کنید که `NEXT_PUBLIC_API_URL` درست تنظیم شده

## نتیجه‌گیری

با این تغییرات:
- ✅ مشکل "request entity too large" حل شد
- ✅ سرعت آپلود افزایش یافت
- ✅ مدیریت فایل‌ها بهینه شد
- ✅ از استاندارد صنعتی استفاده شد

این روش همون روشی هست که تیم‌های حرفه‌ای مثل Amazon، Instagram و ... استفاده می‌کنن.
